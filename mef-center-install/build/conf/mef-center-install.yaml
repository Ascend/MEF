component: mef-center-install
tool: MEF-center-installer
product: MEF_Center
systemEnv:
  - workspace
  - processor
  - version
TOP_DIR: "{{systemEnv.workspace}}/{{product}}/{{component}}"
DST_MEF_CENTER_SBIN_DIR: "{{TOP_DIR}}/output/bin"
compile:
  input:
    dependency:
      - name: huawei_secure_c
        version: 1.0
        type: opensource
      - name: KMC
        version: 1.0
        type: opensource
    envVariables:
      GO111MODULE: "on"
      GONOSUMDB: "*"
      GOPROXY: "http://mirrors.tools.huawei.com/goproxy,direct"
      CGO_ENABLED: "1"
      CGO_CFLAGS: "-fstack-protector-strong -D_FORTIFY_SOURCE=2 -O2 -fPIC -ftrapv"
      CGO_CPPFLAGS: "-fstack-protector-strong -D_FORTIFY_SOURCE=2 -O2 -fPIC -ftrapv"
    files:


  process:
    language: go
    compilePath: "{{TOP_DIR}}/tools/install"
    parameters: [['buildmode', "pie"],
                 ["mod", "mod"],
                 ['ldflags', '-X "main.BuildName={{tool}}" -X "main.BuildVersion={{version}}_linux-{{systemEnv.processor}}" -s -linkmode=external -extldflags=-Wl,-z,now'],
                 ["o", "{{tool}}"],
                 ['trimpath',""],]

  output:
    files:
      include:
        - makedir:
            path: "{{DST_MEF_CENTER_SBIN_DIR}}"
        - move:
            src: ["{{TOP_DIR}}/tools/install/{{tool}}"]
            des: "{{DST_MEF_CENTER_SBIN_DIR}}"
        - move:
            src: ["{{TOP_DIR}}/scripts/install.sh"]
            des: "{{TOP_DIR}}/output"
        - commands:
            - command: "commit_id=$(git --git-dir {{systemEnv.workspace}}/{{product}}/.git rev-parse HEAD) && sed -i s/{commit_id}/${commit_id}/g {{TOP_DIR}}/build/version.xml"
        - sed:
            option: "-i"
            srcstr: "s/{version}/{{version}}/g"
            curfile: "{{TOP_DIR}}/build/version.xml"
        - sed:
            option: "-i"
            srcstr: "s/{arch}/{{systemEnv.processor}}/g"
            curfile: "{{TOP_DIR}}/build/version.xml"
        - move:
            src: [ "{{TOP_DIR}}/build/version.xml" ]
            des: "{{TOP_DIR}}/output"
        - move:
            src: [ "{{TOP_DIR}}/config" ]
            des: "{{TOP_DIR}}/output"
        - move:
            src: ["{{TOP_DIR}}/scripts"]
            des: "{{TOP_DIR}}/output"
        - makedir:
            path: "{{TOP_DIR}}/output/lib/kmc-lib"
        - makedir:
            path: "{{TOP_DIR}}/output/lib/lib"
        - copy:
            src: [ '{{ systemEnv.workspace }}/lib/*' ]
            des: "{{TOP_DIR}}/output/lib/kmc-lib"
        - mode:
            src: [ "{{TOP_DIR}}/output/lib" ]
            mode: "700"
        - mode:
            src: [ "{{TOP_DIR}}/output/lib/*" ]
            mode: "500"
        - mode:
            src: [ "{{TOP_DIR}}/output/install.sh" ]
            mode: "500"
        - mode:
            src: [ "{{TOP_DIR}}/output/bin" ]
            mode: "700"
        - mode:
            src: [ "{{DST_MEF_CENTER_SBIN_DIR}}/{{tool}}" ]
            mode: "500"
        - mode:
            src: [ "{{TOP_DIR}}/output/version.xml" ]
            mode: "400"
        - mode:
            src: [ "{{TOP_DIR}}/output/scripts" ]
            mode: "700"
        - mode:
            src: [ "{{TOP_DIR}}/output/scripts/*" ]
            mode: "500"
        - mode:
            src: [ "{{TOP_DIR}}/output/config" ]
            mode: "700"
        - mode:
            src: [ "{{TOP_DIR}}/output/config/*" ]
            mode: "600"
