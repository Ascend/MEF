component: mef-center-log-export-tool
tool: MEF-center-log-export-tool
product: MEF_Center
systemEnv:
  - workspace
  - processor
  - version
TOP_DIR: "{{systemEnv.workspace}}/{{product}}/mef-center-install"
DST_MEF_CENTER_TOOLS_DIR: "{{TOP_DIR}}/output/tools/log-export-tool"
compile:
  input:
    dependency:
      - name: KMC
        version: 1.0
        type: opensource
    envVariables:
      GO111MODULE: "on"
      GONOSUMDB: "*"
      GOPROXY: "http://mirrors.tools.huawei.com/goproxy,direct"
      CGO_ENABLED: "1"
      CGO_CFLAGS: "-fstack-protector-strong -D_FORTIFY_SOURCE=2 -O2 -fPIC -ftrapv"
      CGO_CPPFLAGS: "-fstack-protector-strong -D_FORTIFY_SOURCE=2 -O2 -fPIC -ftrapv"

  process:
    language: go
    compilePath: "{{TOP_DIR}}/tools/logexporttool"
    parameters: [ [ 'buildmode', "pie" ],
                  [ "mod", "mod" ],
                  [ 'ldflags', '-X "main.BuildName={{tool}}" -X "main.BuildVersion={{version}}_linux-{{systemEnv.processor}}" -s -linkmode=external -extldflags=-Wl,-z,now' ],
                  [ "o", "{{tool}}" ],
                  [ 'trimpath',"" ], ]

  output:
    files:
      include:
        - makedir:
            path: "{{DST_MEF_CENTER_TOOLS_DIR}}"
        - move:
            src: [ "{{TOP_DIR}}/tools/logexporttool/{{tool}}" ]
            des: "{{DST_MEF_CENTER_TOOLS_DIR}}"
        - copy:
            src:
              - '{{TOP_DIR}}/build/log_export_tool.yaml'
            des: "{{DST_MEF_CENTER_TOOLS_DIR}}/log_export_tool-template.yaml"
            rename: True
