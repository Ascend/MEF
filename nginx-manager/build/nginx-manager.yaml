apiVersion: v1
kind: ServiceAccount
metadata:
  name: ascend-nginx-manager
  namespace: mef-center
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ascend-nginx-manager
  namespace: mef-center
spec:
  selector:
    matchLabels:
      app: ascend-nginx-manager
  template:
    metadata:
      labels:
        app: ascend-nginx-manager
    spec:
      nodeSelector:
        masterselector: dls-master-node
      imagePullSecrets:
        - name: image-pull-secret
      serviceAccountName: ascend-nginx-manager
      containers:
        - name: ascend-nginx-manager
          image: ascend-nginx-manager:v1
          env:
            - name: EdgeMgrSvcDomain
              value: "ascend-edge-manager.mindx-edge.svc.cluster.local"
            - name: EdgeMgrSvcPort
              value: "8109"
            - name: SoftwareMgrSvcDomain
              value: "software-manager-service.mindx-edge.svc.cluster.local"
            - name: SoftwareMgrSvcPort
              value: "30086"
            - name: installed-module
              value: '"{}"'
          command: [ "/bin/bash", "-c", "--"]
          args: ["./nginx-manager"]
          volumeMounts:
            - mountPath: "/home/MEFCenter/log/"
              name: nginx-manager-log
            - mountPath: "/home/MEFCenter/certs/"
              name: root-ca
            - mountPath: "/home/data/"
              name: nginx-manager-config
      volumes:
        - name: nginx-manager-config
          hostPath:
            path: /var/mef-center_log/nginx-manager
        - name: root-ca
          hostPath:
            path: /usr/local/MEF-Center/mef-config/root-ca
        - name: nginx-manager-log
          hostPath:
            path: /usr/local/MEF-Center/mef-config/nginx-manager

---
apiVersion: v1
kind: Service
metadata:
  name: ascend-nginx-manager
  namespace: mef-center
  labels:
    app: ascend-nginx-manager
spec:
  ports:
    - name: port80
      port: 80
      targetPort: 80
      protocol: TCP
      nodePort: 30034
    - name: port443
      port: 443
      targetPort: 443
      protocol: TCP
      nodePort: 30035
  selector:
    app: ascend-nginx-manager
  type: NodePort
