apiVersion: v1
kind: ServiceAccount
metadata:
  name: ascend-nginx-manager
  namespace: mef-center
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ascend-nginx-manager
  namespace: mef-center
spec:
  selector:
    matchLabels:
      app: ascend-nginx-manager
  template:
    metadata:
      labels:
        app: ascend-nginx-manager
    spec:
      nodeSelector:
        mef-center-node: ""
      imagePullSecrets:
        - name: image-pull-secret
      serviceAccountName: ascend-nginx-manager
      containers:
        - name: ascend-nginx-manager
          image: ascend-nginx-manager:v1
          env:
            - name: EdgeMgrSvcDomain
              value: "ascend-edge-manager.mef-center.svc.cluster.local"
            - name: EdgeMgrSvcPort
              value: "8101"
            - name: SoftwareMgrSvcDomain
              value: "ascend-software-manager.mef-center.svc.cluster.local"
            - name: SoftwareMgrSvcPort
              value: "8102"
            - name: CertMgrSvcDomain
              value: "ascend-cert-manager.mef-center.svc.cluster.local"
            - name: CertMgrSvcPort
              value: "8103"
            - name: installed-module
              value: ${installed_module}
          command: [ "/bin/bash", "-c", "--"]
          args: ["./nginx-manager"]
          volumeMounts:
            - name: nginx-manager-log
              mountPath: /home/MEFCenter/log/
            - name: root-ca
              mountPath: /home/data/inner-root-ca/
            - name: nginx-manager-config
              mountPath: /home/data/config
      volumes:
        - name: nginx-manager-config
          hostPath:
            path: ${config}
        - name: root-ca
          hostPath:
            path: ${root-ca}
        - name: nginx-manager-log
          hostPath:
            path: ${log}

---
apiVersion: v1
kind: Service
metadata:
  name: ascend-nginx-manager
  namespace: mef-center
  labels:
    app: ascend-nginx-manager
spec:
  ports:
    - name: port443
      port: 8443
      targetPort: 8443
      protocol: TCP
      nodePort: 30035
  selector:
    app: ascend-nginx-manager
  type: NodePort
