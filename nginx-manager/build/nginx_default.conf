worker_processes 1;
worker_cpu_affinity 0001;

worker_rlimit_nofile 4096;
events {
    worker_connections 4096;
}

http {
    include mime.types;
    default_type application/octet-stream;
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for" "$request_time"';
    access_log /home/hwMindX/log/access.log main;
    error_log /home/hwMindX/log/error.log;
    sendfile on;
    keepalive_timeout  60;
    proxy_read_timeout 2400;
    proxy_connect_timeout   60;
    proxy_send_timeout      60;
    client_header_timeout   60;
    client_header_buffer_size  1k;
    large_client_header_buffers  4  8k;
    client_body_buffer_size  16K;
    client_body_timeout   60;
    send_timeout          60;
    server_tokens off;
    port_in_redirect off;
    keepalive_requests 100;
    proxy_request_buffering off;

    limit_req_zone global zone=req_zone:1m rate=1000r/s;
    limit_req_zone $binary_remote_addr zone=event_zone:10m rate=20r/s;
    limit_conn_zone $binary_remote_addr zone=conn_zone:10m;
    limit_conn_zone $server_name zone=perserver:10m;

    server{
        listen 80;

        server_name localhost;
        #resolver 10.96.0.10 valid=15s;
        resolver kube-dns.kube-system.svc.cluster.local valid=15s;
        location / {
            limit_except GET{
                deny all;
            }
            proxy_hide_header     X-Powered-By;
            client_max_body_size 10m;
            root /home/hwMindX/dist;
            index index.html index.htm;
        }
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root /home/hwMindX/dist;
        }
        error_page   400 401 402 403 404 405 406 407 413 414 /4xx.html;
        location = /4xx.html {
            root /home/hwMindX/dist;
        }
        location /edgemanager {
            default_type application/json;
            add_header Strict-Transport-Security "max-age=31536000 includeSubDomains" always;
            add_header X-XSS-Protection "1; mode=block" always;
            add_header X-Content-Type-Options nosniff always;

            add_header Content-Security-Policy "script-src 'self' 'unsafe-inline' 'unsafe-eval';object-src 'none'; " always;
            add_header X-frame-options SAMEORIGIN always;
            add_header Pragma no-cache always;
            add_header Cache-Control no-store always;
            add_header X-Download-Options noopen always;
            set $EdgeMgrSvcDomain;
            set $EdgeMgrSvcPort;
            proxy_pass http://$EdgeMgrSvcDomain:$EdgeMgrSvcPort;
        }
        location /softwaremanager {
            default_type application/json;
            add_header Strict-Transport-Security "max-age=31536000 includeSubDomains" always;
            add_header X-XSS-Protection "1; mode=block" always;
            add_header X-Content-Type-Options nosniff always;
            add_header Content-Security-Policy "script-src 'self' 'unsafe-inline' 'unsafe-eval';object-src 'none'; " always;
            add_header X-frame-options SAMEORIGIN always;
            add_header Pragma no-cache always;
            add_header Cache-Control no-store always;
            add_header X-Download-Options noopen always;
            set $SoftwareMgrSvcDomain;
            set $SoftwareMgrSvcPort;
            proxy_pass http://$SoftwareMgrSvcDomain:$SoftwareMgrSvcPort;
        }
    }
    server{
        listen 443 ssl;

        server_name localhost;
        resolver kube-dns.kube-system.svc.cluster.local valid=15s;
	    #resolver 10.96.0.10 valid=15;
        ssl_certificate     /home/hwMindX/certs/nginx-manager.crt;
        ssl_certificate_key /home/hwMindX/conf/keyPipe;
        add_header Content-Security-Policy "script-src 'self' 'unsafe-inline' 'unsafe-eval'; form-action 'self'; frame-ancestors 'self'; plugin-types 'none'";
        ssl_ciphers "ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256 !aNULL !eNULL !LOW !3DES !MD5 !EXP !PSK !SRP !DSS !RC4";
        limit_req zone=event_zone burst=60 nodelay;
        limit_conn conn_zone 10;
        limit_conn perserver 100;
        location / {
            limit_except GET{
                deny all;
            }
            proxy_hide_header     X-Powered-By;
            client_max_body_size 10m;
            root /home/hwMindX/dist;
            index index.html index.htm;
        }
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root /home/hwMindX/dist;
        }
        error_page   400 401 402 403 404 405 406 407 413 414 /4xx.html;
        location = /4xx.html {
            root /home/hwMindX/dist;
        }
        location /edgemanager {
            proxy_ssl_certificate /home/hwMindX/certs/client.crt;
            proxy_ssl_certificate_key /home/hwMindX/conf/client_pipe_0;
            proxy_ssl_trusted_certificate /home/hwMindX/certs/ca.crt;
            proxy_ssl_verify on;
            proxy_ssl_session_reuse on;
            proxy_ssl_protocols TLSv1.2 TLSv1.3;
            proxy_ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384";
            client_max_body_size 10m;
	        set $EdgeMgrSvcDomain;
            set $EdgeMgrSvcPort;
            proxy_pass https://$EdgeMgrSvcDomain:$EdgeMgrSvcPort;
        }
        location /softwaremanager {
	        proxy_ssl_certificate /home/hwMindX/certs/client.crt;
            proxy_ssl_certificate_key /home/hwMindX/conf/client_pipe_1;
            proxy_ssl_trusted_certificate /home/hwMindX/certs/ca.crt;
            proxy_ssl_verify on;
            proxy_ssl_session_reuse on;
	        proxy_ssl_protocols TLSv1.2 TLSv1.3;
            proxy_ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384";
            client_max_body_size 10m;
	        set $SoftwareMgrSvcDomain;
            set $SoftwareMgrSvcPort;
            proxy_pass https://$SoftwareMgrSvcDomain:$SoftwareMgrSvcPort;
        }
    }
}