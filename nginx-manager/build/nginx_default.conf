worker_processes 1;
worker_cpu_affinity 0001;

worker_rlimit_nofile 4096;
events {
    worker_connections 4096;
}

pid /home/MEFCenter/nginx.pid;

http {
    include mime.types;
    default_type application/octet-stream;
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for" "$request_time"';
    access_log /home/MEFCenter/logs/access.log main;
    error_log /home/MEFCenter/logs/error.log;
    sendfile on;
    keepalive_timeout  60;
    proxy_read_timeout 900;
    proxy_connect_timeout   60;
    proxy_send_timeout      60;
    client_header_timeout   60;
    client_header_buffer_size  1k;
    large_client_header_buffers  4  8k;
    client_max_body_size 1025k;
    client_body_buffer_size  16K;
    client_body_timeout   60;
    send_timeout          60;
    server_tokens off;
    port_in_redirect off;
    keepalive_requests 100;
    proxy_request_buffering off;
    proxy_buffering off;
    proxy_hide_header X-Powered-By;
    autoindex off;
    ssl_session_cache shared:SSL:2m;
    ssl_session_timeout 5m;
    ssl_prefer_server_ciphers on;
    ssl_session_tickets off;

    limit_req_zone global zone=req_zone:1m rate=1000r/s;
    limit_req_zone $binary_remote_addr zone=event_zone:10m rate=10r/s;
    limit_conn_zone $binary_remote_addr zone=conn_zone:10m;
    limit_conn_zone global zone=websocket_conn_zone:10m;
    limit_conn_zone global zone=north_conn_zone:10m;
    limit_conn_zone global zone=global_upload_conn_zone:1m;
    limit_conn_zone global zone=global_download_conn_zone:1m;
    limit_conn_zone $binary_remote_addr zone=per_addr_upload_conn_zone:10m;

    limit_conn_status  429;
    limit_req_status 429;
    server{
        listen $POD_IP:$NginxSslPort ssl;

        server_name localhost;
        resolver kube-dns.kube-system.svc.cluster.local valid=15s;
        ssl_certificate     /home/data/config/mef-certs/nginx-manager-server.crt;
        ssl_certificate_key /home/MEFCenter/pipe/apig_keyPipe;

        ssl_client_certificate /home/data/config/mef-certs/northern-root.crt;
        ssl_verify_client on;
        ssl_verify_depth 9;
        $SslCrlPath

        add_header X-XSS-Protection "1; mode=block";
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
        add_header Strict-Transport-Security " max-age=31536000; includeSubDomains ";
        add_header Content-Security-Policy "default-src 'self'";
        add_header Cache-control "no-cache, no-store, must-revalidate";
        add_header Pragma no-cache;
        add_header Expires 0;
        add_header Referrer-Policy same-origin;

        ssl_protocols TLSv1.2;
        ssl_ciphers "ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256 !MEDIUM !LOW !EXPORT !aNULL !eNULL !LOW !3DES !MD5 !EXP !PSK !SRP !DSS !RC4 @STRENGTH";
        limit_req zone=event_zone burst=5 nodelay;
        limit_conn conn_zone 5;
        limit_conn north_conn_zone 5;
        location / {
            limit_except GET {
                deny all;
            }
            root /home/MEFCenter/dist;
            index index.html index.htm;
        }
        error_page   500 501 502 503 504  /50x.html;
        location = /50x.html {
            root /home/MEFCenter/html;
            index 50x.html;
        }
        error_page   400 401 402 403 404 405 406 407 413 414 /4xx.html;
        location = /4xx.html {
            root /home/MEFCenter/html;
            index 4xx.html;
        }

        location /edgemanager {
            proxy_set_header X-Forwarded-For $remote_addr;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            proxy_request_buffering off;
            proxy_ssl_certificate /home/data/config/mef-certs/nginx-manager.crt;
            proxy_ssl_certificate_key /home/MEFCenter/pipe/client_pipe_0;
            proxy_ssl_trusted_certificate /home/data/inner-root-ca/RootCA.crt;
            proxy_ssl_verify on;
            proxy_ssl_session_reuse on;
            proxy_ssl_protocols TLSv1.3;
            proxy_ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384";
            proxy_pass https://ascend-edge-manager.mef-center.svc.cluster.local:$EdgeMgrSvcPort;
            limit_except GET POST PATCH {
                deny all;
            }

            location /edgemanager/v1/logmgmt/dump/download {
                limit_conn global_download_conn_zone 1;
                proxy_send_timeout 7200;

                proxy_pass https://ascend-edge-manager.mef-center.svc.cluster.local:$EdgeMgrSvcPort;
                limit_except GET {
                    deny all;
                }
            }
        }

        location /certmanager {
            proxy_set_header X-Forwarded-For $remote_addr;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            proxy_request_buffering off;
            proxy_ssl_certificate /home/data/config/mef-certs/nginx-manager.crt;
            proxy_ssl_certificate_key /home/MEFCenter/pipe/client_pipe_1;
            proxy_ssl_trusted_certificate /home/data/inner-root-ca/RootCA.crt;
            proxy_ssl_verify on;
            proxy_ssl_session_reuse on;
            proxy_ssl_protocols TLSv1.3;
            proxy_ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384";
            proxy_pass https://ascend-cert-manager.mef-center.svc.cluster.local:$CertMgrSvcPort;
            limit_except GET POST PATCH {
                deny all;
            }
        }

        location /alarmmanager {
            proxy_set_header X-Forwarded-For $remote_addr;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            proxy_request_buffering off;
            proxy_ssl_certificate /home/data/config/mef-certs/nginx-manager.crt;
            proxy_ssl_certificate_key /home/MEFCenter/pipe/client_pipe_4;
            proxy_ssl_trusted_certificate /home/data/inner-root-ca/RootCA.crt;
            proxy_ssl_verify on;
            proxy_ssl_session_reuse on;
            proxy_ssl_protocols TLSv1.3;
            proxy_ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384";
            proxy_pass https://ascend-alarm-manager.mef-center.svc.cluster.local:$AlarmMgrSvcPort;
            limit_except GET POST PATCH {
                deny all;
            }
        }
    }
    server{
        listen $POD_IP:$AuthPort ssl;

        ssl_certificate     /home/data/config/mef-certs/south-auth-server.crt;
        ssl_certificate_key /home/MEFCenter/pipe/apig_auth_keyPipe;
        ssl_protocols TLSv1.3;
        ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384 !MEDIUM !LOW !EXPORT !aNULL !eNULL !LOW !3DES !MD5 !EXP !PSK !SRP !DSS !RC4 @STRENGTH";

        add_header X-XSS-Protection "1; mode=block";
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
        add_header Strict-Transport-Security " max-age=31536000; includeSubDomains ";
        add_header Content-Security-Policy "default-src 'self'";
        add_header Cache-control "no-cache, no-store, must-revalidate";
        add_header Pragma no-cache;
        add_header Expires 0;
        add_header Referrer-Policy same-origin;

        error_page   500 501 502 503 504  /50x.html;
        location = /50x.html {
            root /home/MEFCenter/html;
            index 50x.html;
        }
        error_page   400 401 402 403 404 405 406 407 413 414 /4xx.html;
        location = /4xx.html {
            root /home/MEFCenter/html;
            index 4xx.html;
        }

        limit_req zone=event_zone burst=5 nodelay;
        limit_conn conn_zone 5;
        location /token {
            proxy_set_header X-Forwarded-For $remote_addr;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            proxy_request_buffering off;
            proxy_ssl_certificate /home/data/config/mef-certs/nginx-manager.crt;
            proxy_ssl_certificate_key /home/MEFCenter/pipe/client_pipe_2;
            proxy_ssl_trusted_certificate /home/data/inner-root-ca/RootCA.crt;
            proxy_ssl_verify on;
            proxy_ssl_session_reuse on;
            proxy_ssl_protocols TLSv1.3;
            proxy_ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384";
            proxy_pass https://ascend-edge-manager.mef-center.svc.cluster.local:$AuthPort;
            limit_except GET POST {
                deny all;
            }
        }
    }
    map $http_upgrade $connection_upgrade {
                                        default upgrade;
                                        ''      close;
                                    }
    server{
            listen $POD_IP:$WebsocketPort ssl;

            ssl_certificate     /home/data/config/mef-certs/south-websocket-server.crt;
            ssl_certificate_key /home/MEFCenter/pipe/apig_websocket_keyPipe;
            ssl_client_certificate /home/data/config/mef-certs/southern-root.crt;
            ssl_verify_client on;
            ssl_verify_depth 9;
            ssl_protocols TLSv1.3;
            ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384 !MEDIUM !LOW !EXPORT !aNULL !eNULL !LOW !3DES !MD5 !EXP !PSK !SRP !DSS !RC4 @STRENGTH";

            add_header X-XSS-Protection "1; mode=block";
            add_header X-Frame-Options DENY;
            add_header X-Content-Type-Options nosniff;
            add_header Strict-Transport-Security " max-age=31536000; includeSubDomains ";
            add_header Content-Security-Policy "default-src 'self'";
            add_header Cache-control "no-cache, no-store, must-revalidate";
            add_header Pragma no-cache;
            add_header Expires 0;
            add_header Referrer-Policy same-origin;

            error_page   500 501 502 503 504  /50x.html;
            location = /50x.html {
                root /home/MEFCenter/html;
                index 50x.html;
            }
            error_page   400 401 402 403 404 405 406 407 413 414 /4xx.html;
            location = /4xx.html {
                root /home/MEFCenter/html;
                index 4xx.html;
            }

            limit_req zone=event_zone burst=5 nodelay;
            limit_conn conn_zone 5;
            limit_conn websocket_conn_zone 2048;
            location / {
                proxy_set_header Host $host;
                proxy_set_header Upgrade $http_upgrade;
                proxy_set_header Connection $connection_upgrade;

                proxy_set_header X-Forwarded-For $remote_addr;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_pass_request_headers on;
                proxy_pass_request_body on;
                proxy_request_buffering off;
                proxy_ssl_certificate /home/data/config/mef-certs/nginx-manager.crt;
                proxy_ssl_certificate_key /home/MEFCenter/pipe/client_pipe_3;
                proxy_ssl_trusted_certificate /home/data/inner-root-ca/RootCA.crt;
                proxy_ssl_verify on;
                proxy_ssl_session_reuse on;
                proxy_ssl_protocols TLSv1.3;
                proxy_ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384";
                proxy_pass https://ascend-edge-manager.mef-center.svc.cluster.local:$WebsocketPort;
                limit_except GET {
                    deny all;
                }

                location /logmgmt/dump/upload {
                    limit_conn per_addr_upload_conn_zone 1;
                    limit_conn global_upload_conn_zone 10;
                    client_max_body_size 200m;
                    client_body_timeout   600;
                    proxy_http_version 1.1;
                    proxy_request_buffering off;

                    proxy_pass https://ascend-edge-manager.mef-center.svc.cluster.local:$WebsocketPort;
                    limit_except POST {
                        deny all;
                    }
                }
            }
        }
}