worker_processes 1;
worker_cpu_affinity 0001;

worker_rlimit_nofile 4096;
events {
    worker_connections 4096;
}

http {
    include mime.types;
    default_type application/octet-stream;
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for" "$request_time"';
    access_log /home/MEFCenter/logs/access.log main;
    error_log /home/MEFCenter/logs/error.log;
    sendfile on;
    keepalive_timeout  60;
    proxy_read_timeout 900;
    proxy_connect_timeout   60;
    proxy_send_timeout      60;
    client_header_timeout   60;
    client_header_buffer_size  1k;
    large_client_header_buffers  4  8k;
    client_body_buffer_size  16K;
    client_body_timeout   60;
    send_timeout          60;
    server_tokens off;
    port_in_redirect off;
    keepalive_requests 100;
    proxy_request_buffering off;
    proxy_buffering off;

    set_real_ip_from 0.0.0.0/0;
    real_ip_header  X-Forwarded-For;
    real_ip_recursive on;

    proxy_set_header Host      $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    limit_req_zone global zone=req_zone:1m rate=1000r/s;
    limit_req_zone $binary_remote_addr zone=event_zone:10m rate=30r/s;
    limit_conn_zone $binary_remote_addr zone=conn_zone:10m;
    limit_conn_zone $server_name zone=perserver:10m;

    lua_code_cache on;
    lua_shared_dict session_cache 10m;
    lua_shared_dict ip_failed_cache 10m;
    lua_shared_dict user_failed_cache 10m;

    lua_package_path "${prefix}lua/?.lua;;";
    init_by_lua_file /home/MEFCenter/lua/init.lua;

    resolver 127.0.0.1;
    upstream apigw {
        server 0.0.0.0;
        balancer_by_lua_file lua/apigw.lua;
    }

    server{
        listen $NginxSslPort ssl;

        server_name localhost;
        resolver kube-dns.kube-system.svc.cluster.local valid=15s;
	    #resolver 10.96.0.10 valid=15;
        ssl_certificate     /home/data/config/mef-certs/nginx-manager-server.crt;
        ssl_certificate_key /home/MEFCenter/pipe/apig_keyPipe;
        add_header Content-Security-Policy "script-src 'self' 'unsafe-inline' 'unsafe-eval'; form-action 'self'; frame-ancestors 'self'; plugin-types 'none'";
        ssl_protocols TLSv1.2;
        ssl_ciphers "ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256 !aNULL !eNULL !LOW !3DES !MD5 !EXP !PSK !SRP !DSS !RC4";
        limit_req zone=event_zone burst=60 nodelay;
        limit_conn conn_zone 10;
        limit_conn perserver 100;
        location / {
            limit_except GET {
                deny all;
            }
            proxy_hide_header     X-Powered-By;
            client_max_body_size 10m;
            root /home/MEFCenter/dist;
            index index.html index.htm;
        }
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root /home/MEFCenter/html;
            index 50x.html;
        }
        error_page   400 401 402 403 404 405 406 407 413 414 /4xx.html;
        location = /4xx.html {
            root /home/MEFCenter/html;
            index 4xx.html;
        }

        # apigw  lua api
        location = /api/v1/login {
            set $service_name "";
            content_by_lua_file lua/login.lua;
        }

         # pass login to login
         location = /internal/login {
             internal;
             proxy_ssl_certificate /home/data/config/mef-certs/nginx-manager.crt;
             proxy_ssl_certificate_key /home/MEFCenter/pipe/client_pipe_0;
             proxy_ssl_trusted_certificate /home/data/inner-root-ca/RootCA.crt;
             proxy_ssl_protocols TLSv1.2 TLSv1.3;
             proxy_ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384";
             proxy_pass https://apigw/usermanager/v1/login$is_args$args;
         }

         location = /api/v1/change {
            set $service_name "";
            content_by_lua_file lua/change.lua;
         }

         location = /internal/change {
             internal;
             proxy_ssl_certificate /home/data/config/mef-certs/nginx-manager.crt;
             proxy_ssl_certificate_key /home/MEFCenter/pipe/client_pipe_1;
             proxy_ssl_trusted_certificate /home/data/inner-root-ca/RootCA.crt;
             proxy_ssl_protocols TLSv1.2 TLSv1.3;
             proxy_ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384";
             proxy_pass https://apigw/usermanager/v1/change$is_args$args;
         }

         location = /internal/islocked {
              internal;
              proxy_ssl_certificate /home/data/config/mef-certs/nginx-manager.crt;
              proxy_ssl_certificate_key /home/MEFCenter/pipe/client_pipe_2;
              proxy_ssl_trusted_certificate /home/data/inner-root-ca/RootCA.crt;
              proxy_ssl_protocols TLSv1.2 TLSv1.3;
              proxy_ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384";
              proxy_pass https://apigw/usermanager/v1/islocked$is_args$args;
         }

        location = /api/v1/logout {
            set $service_name "";
            content_by_lua_file lua/logout.lua;
        }

        location = /api/v1/first-change {
           set $service_name "";
           proxy_ssl_certificate /home/data/config/mef-certs/nginx-manager.crt;
           proxy_ssl_certificate_key /home/MEFCenter/pipe/client_pipe_3;
           proxy_ssl_trusted_certificate /home/data/inner-root-ca/RootCA.crt;
           proxy_ssl_protocols TLSv1.2 TLSv1.3;
           proxy_ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384";
           proxy_pass https://127.0.0.1:$UserMgrSvcPort/usermanager/v1/first-change;
        }

        location ~ ^/(edgemanager|softwaremanager|usermanager)/(.*?)$ {
            set $target_ip "";
            set $target_port "";
            set $service_name $1;
            set $target_host "";
            access_by_lua_file lua/access.lua;
            proxy_set_header Host $target_host;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            proxy_request_buffering off;
            proxy_ssl_certificate /home/data/config/mef-certs/nginx-manager.crt;
            proxy_ssl_certificate_key /home/MEFCenter/pipe/client_pipe_4;
            proxy_ssl_trusted_certificate /home/data/inner-root-ca/RootCA.crt;
            proxy_ssl_verify on;
            proxy_ssl_name $target_host;
            proxy_ssl_session_reuse on;
            proxy_ssl_protocols TLSv1.2 TLSv1.3;
            proxy_ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384";
            proxy_pass https://apigw/$1/$2$is_args$args;
        }
    }
}