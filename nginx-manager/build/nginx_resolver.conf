worker_processes 1;
worker_cpu_affinity 0001;

worker_rlimit_nofile 4096;
events {
    worker_connections 4096;
}

pid /home/MEFCenter/nginx.pid;

http {
    include mime.types;
    default_type application/octet-stream;
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for" "$request_time"';
    access_log /home/MEFCenter/logs/access.log main;
    error_log /home/MEFCenter/logs/error.log;
    sendfile on;
    keepalive_timeout  60;
    proxy_read_timeout 900;
    proxy_connect_timeout   60;
    proxy_send_timeout      60;
    client_header_timeout   60;
    client_header_buffer_size  1k;
    large_client_header_buffers  4  8k;
    client_max_body_size 10m;
    client_body_buffer_size  16K;
    client_body_timeout   60;
    send_timeout          60;
    server_tokens off;
    port_in_redirect off;
    keepalive_requests 100;
    proxy_request_buffering off;
    proxy_buffering off;

    limit_req_zone global zone=req_zone:1m rate=1000r/s;
    limit_req_zone $binary_remote_addr zone=event_zone:10m rate=300r/s;
    limit_conn_zone $binary_remote_addr zone=conn_zone:10m;
    limit_conn_zone $server_name zone=perserver:10m;

    server{
        listen $POD_IP:$NginxSslPort ssl;

        server_name localhost;
        resolver kube-dns.kube-system.svc.cluster.local valid=15s;
	    #resolver 10.96.0.10 valid=15;
        ssl_certificate     /home/data/config/mef-certs/nginx-manager-server.crt;
        ssl_certificate_key /home/MEFCenter/pipe/apig_keyPipe;

        ssl_client_certificate /home/data/config/mef-certs/northern-root.crt;
        ssl_verify_client on;

        add_header Content-Security-Policy "script-src 'self' 'unsafe-inline' 'unsafe-eval'; form-action 'self'; frame-ancestors 'self'; plugin-types 'none'";
        ssl_protocols TLSv1.2;
        ssl_ciphers "ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256 !aNULL !eNULL !LOW !3DES !MD5 !EXP !PSK !SRP !DSS !RC4";
        limit_req zone=event_zone burst=60 nodelay;
        limit_conn conn_zone 300;
        limit_conn perserver 300;
        location / {
            limit_except GET {
                deny all;
            }
            proxy_hide_header     X-Powered-By;
            root /home/MEFCenter/dist;
            index index.html index.htm;
        }
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root /home/MEFCenter/html;
            index 50x.html;
        }
        error_page   400 401 402 403 404 405 406 407 413 414 /4xx.html;
        location = /4xx.html {
            root /home/MEFCenter/html;
            index 4xx.html;
        }

        location /edgemanager {
            proxy_set_header X-Real-IP $remote_addr;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            proxy_request_buffering off;
            proxy_ssl_certificate /home/data/config/mef-certs/nginx-manager.crt;
            proxy_ssl_certificate_key /home/MEFCenter/pipe/client_pipe_0;
            proxy_ssl_trusted_certificate /home/data/inner-root-ca/RootCA.crt;
            proxy_ssl_verify on;
            proxy_ssl_session_reuse on;
            proxy_ssl_protocols TLSv1.2 TLSv1.3;
            proxy_ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384";
            set $EdgeMgrSvc ascend-edge-manager.mef-center.svc.cluster.local;
            proxy_pass https://$EdgeMgrSvc:$EdgeMgrSvcPort;
        }

        location /certmanager {
            proxy_set_header X-Real-IP $remote_addr;
            proxy_pass_request_headers on;
            proxy_pass_request_body on;
            proxy_request_buffering off;
            proxy_ssl_certificate /home/data/config/mef-certs/nginx-manager.crt;
            proxy_ssl_certificate_key /home/MEFCenter/pipe/client_pipe_1;
            proxy_ssl_trusted_certificate /home/data/inner-root-ca/RootCA.crt;
            proxy_ssl_verify on;
            proxy_ssl_session_reuse on;
            proxy_ssl_protocols TLSv1.2 TLSv1.3;
            proxy_ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384";
            set $CertMgrSvc ascend-cert-manager.mef-center.svc.cluster.local;
            proxy_pass https://$CertMgrSvc:$CertMgrSvcPort;
        }
    }
}