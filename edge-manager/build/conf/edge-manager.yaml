component: edge-manager
product: MEF_Center
systemEnv:
  - workspace
  - processor
  - version
TOP_DIR: "{{systemEnv.workspace}}/{{product}}/{{component}}"
compile:
  input:
    envVariables:
      GO111MODULE: "on"
      GONOSUMDB: "*"
      GOPROXY: "https://cmc.centralrepo.rnd.huawei.com/artifactory/go-central-repo,direct"
      CGO_ENABLED: "1"
      CGO_CFLAGS: "-fstack-protector-strong -D_FORTIFY_SOURCE=2 -O2 -fPIC -ftrapv"
      CGO_CPPFLAGS: "-fstack-protector-strong -D_FORTIFY_SOURCE=2 -O2 -fPIC -ftrapv"
    files:
      exclude:
        - remove: ["{{TOP_DIR}}/output/"]
        - makedir:
            path: "{{TOP_DIR}}/output"

  process:
    language: go
    compilePath: "{{TOP_DIR}}/cmd"
    parameters: [['buildmode', "pie"],
                 ["mod", "mod"],
                 ['ldflags', '-X "edge-manager/pkg/config.BuildName={{component}}" -X "edge-manager/pkg/config.BuildVersion={{version}}" -s -linkmode=external -extldflags=-Wl,-z,now'],
                 ["o", "{{component}}"],
                 ['trimpath',""],]
  output:
    files:
      include:
        - move:
            src: ["{{TOP_DIR}}/cmd/{{component}}"]
            des: "{{TOP_DIR}}/output"
        - copy:
            src:
              - '{{TOP_DIR}}/build/{{component}}.yaml'
            des: "{{TOP_DIR}}/output/{{component}}.yaml"
            rename: True
        - copy:
            src:
              - "{{TOP_DIR}}/build/Dockerfile"
            des: "{{TOP_DIR}}/output/"
        - makedir:
            path: "{{TOP_DIR}}/output/config"
        - mode:
            src:
              - "{{TOP_DIR}}/output/config"
            mode: "700"
        - copy:
            src:
              - "{{TOP_DIR}}/config/*"
            des: "{{TOP_DIR}}/output/config"
        - mode:
            src:
              - "{{TOP_DIR}}/output/*"
            mode: "400"
        - mode:
            src:
              - "{{TOP_DIR}}/output/config"
            mode: "700"
        - mode:
            src:
              - "{{TOP_DIR}}/output/config/*"
            mode: "600"
        - mode:
            src:
              - "{{TOP_DIR}}/output/{{component}}"
            mode: "500"
        - mode:
            src:
              - "{{TOP_DIR}}/output/{{component}}.yaml"
            mode: "600"
