component: MEF_Center
product: MEF_Center
systemEnv:
  - workspace
  - processor
  - version
TOP_DIR: "{{systemEnv.workspace}}/{{component}}"
CMS_VERIFY_DIR: "{{TOP_DIR}}/MEF_Utils/cmsverifytool"
EDGE_MANAGER_DIR: "{{systemEnv.workspace}}/{{component}}/edge-manager"
SOFTWARE_MANAGER_DIR: "{{systemEnv.workspace}}/{{component}}/software-manager"
CERT_MANAGER_DIR: "{{systemEnv.workspace}}/{{component}}/cert-manager"
MEF_CENTER_INSTALL_DIR: "{{systemEnv.workspace}}/{{component}}/mef-center-install"
NGINX_MANAGER_DIR: "{{systemEnv.workspace}}/{{component}}/nginx-manager"

compile:
  input:
    dependency:
      - name: MEF_Dependency
        version: "1.0"
        type: opensource
        buildFile: "{{TOP_DIR}}/build/conf"
      - name: edge-manager
        version: "1.0"
        type: opensource
        buildFile: "{{EDGE_MANAGER_DIR}}/build/conf"
      - name: cert-manager
        version: "1.0"
        type: opensource
        buildFile: "{{CERT_MANAGER_DIR}}/build/conf"
      - name: mef-center-install
        version: "1.0"
        type: opensource
        buildFile: "{{MEF_CENTER_INSTALL_DIR}}/build/conf"
      - name: mef-center-control
        version: "1.0"
        type: opensource
        buildFile: "{{MEF_CENTER_INSTALL_DIR}}/build/conf"
      - name: mef-center-upgrade
        version: "1.0"
        type: opensource
        buildFile: "{{MEF_CENTER_INSTALL_DIR}}/build/conf"
      - name: mef-center-log-export-tool
        version: "1.0"
        type: opensource
        buildFile: "{{MEF_CENTER_INSTALL_DIR}}/build/conf"
      - name: nginx-manager
        version: "1.0"
        type: opensource
        buildFile: "{{NGINX_MANAGER_DIR}}/build/conf"

  process:
    language: go
    compilePath:
    parameters:
  output:
    files:
      include:
        - makedir:
            path: "{{TOP_DIR}}/savedir"
        - makedir:
            path: "{{TOP_DIR}}/savedir/edge-manager"
        - makedir:
            path: "{{TOP_DIR}}/savedir/cert-manager"
        - makedir:
            path: "{{TOP_DIR}}/savedir/installer"
        - makedir:
            path: "{{TOP_DIR}}/savedir/nginx-manager"
        - mode:
            src: [ "{{TOP_DIR}}/savedir" ]
            mode: "700"
        - commands:
            - command: "fakeroot cp -rf {{EDGE_MANAGER_DIR}}/output/* {{TOP_DIR}}/savedir/edge-manager/"
        - commands:
            - command: "fakeroot cp -rf {{MEF_CENTER_INSTALL_DIR}}/output/* {{TOP_DIR}}/savedir/installer/"
        - commands:
            - command: "fakeroot cp -rf {{NGINX_MANAGER_DIR}}/output/* {{TOP_DIR}}/savedir/nginx-manager/"
        - commands:
            - command: "fakeroot cp -rf {{CERT_MANAGER_DIR}}/output/* {{TOP_DIR}}/savedir/cert-manager/"
        - copy:
            src: [ '{{ CMS_VERIFY_DIR }}/build/libcms_verify.so' ]
            des: "{{TOP_DIR}}/savedir/installer/lib/lib"
        - mode :
            src: [ "{{TOP_DIR}}/savedir/installer/lib/lib/libcms_verify.so" ]
            mode: "500"
        - mode:
            src:
              - "{{TOP_DIR}}/savedir/installer/version.xml"
            mode: "400"
        - mode:
            src:
              - "{{TOP_DIR}}/savedir/installer/config/*"
            mode: "600"
        - commands:
            - command: "bash -x {{TOP_DIR}}/build/chmod_prepare.sh {{TOP_DIR}}/savedir"
            - command: "cd {{TOP_DIR}}/savedir && fakeroot tar -zcf Ascend-mindxedge-mefcenter_{{version}}_linux-{{systemEnv.processor}}.tar.gz ./*"
        - copy:
            src:
              - '{{TOP_DIR}}/savedir/Ascend-mindxedge-mefcenter_{{version}}_linux-{{systemEnv.processor}}.tar.gz'
            des: "{{TOP_DIR}}/output/"
        - commands:
            - command: "bash {{ systemEnv.workspace }}/../CI/CleanCode/script/signature.sh MEF_Center"
        - commands:
            - command: "mv {{TOP_DIR}}/output/crldata.crl 
            {{TOP_DIR}}/output/Ascend-mindxedge-mefcenter_{{version}}_linux-{{systemEnv.processor}}.tar.gz.crl"
        - move:
            src: ["{{TOP_DIR}}/savedir/Ascend-mindxedge-mefcenter_{{version}}_linux-{{systemEnv.processor}}.tar.gz"]
            des: "{{TOP_DIR}}/output"
        - commands:
            - command: "fakeroot rm -rf {{TOP_DIR}}/output/lib {{TOP_DIR}}/output/include"
        - mode:
            src:
              - "{{TOP_DIR}}/output/*"
            mode: "400"
        - makeArchive:
            - src: "{{TOP_DIR}}/output/"
              des: "{{TOP_DIR}}/output/Ascend-mindxedge-mefcenter_{{version}}_linux-{{systemEnv.processor}}"
              prefix: zip
              arch: "{{systemEnv.processor}}"
      exclude:
        - remove: ["{{TOP_DIR}}/savedir"]